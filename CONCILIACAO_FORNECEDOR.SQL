WITH CTE AS
(
SELECT 
	CT2_FILORI FILIAL,
	SUBSTRING(CT2_CLVLCR, 2, 6) FORNECEDOR_CR,
	SUBSTRING(CT2_KEY, CHARINDEX('00', CT2_KEY), 9) NF,
	SUM(CT2_VALOR) CREDITO
FROM CT2010
WHERE 
	CT2_DATA LIKE '2023%'
	AND CT2_CREDIT = '210201001'
	AND CT2_KEY <> ''
GROUP BY
	CT2_FILORI, 
	SUBSTRING(CT2_KEY, CHARINDEX('00', CT2_KEY), 9),
	SUBSTRING(CT2_CLVLCR, 2, 6) 
)SELECT
		CTE.FILIAL,
		CTE.CREDITO,
		CTE.NF,
		CTE.FORNECEDOR_CR,
		SUBSTRING(CT.CT2_CLVLCR, 2, 6) FORNECEDOR_DB,
		SUM(CT.CT2_VALOR) DEBITO,
		ISNULL((
			SELECT
				SUM(SE.E2_VALOR) E2_VALOR
			FROM SE2010 SE
			WHERE 
				CTE.FILIAL = SE.E2_FILIAL
				AND CTE.NF = SE.E2_NUM
				AND SE.E2_EMISSAO LIKE '2023%'
		), 0) CONTA_A_PAGAR,ISNULL((
			SELECT
				SUM(SE.E2_SALDO) E2_SALDO
			FROM SE2010 SE
			WHERE 
				CTE.FILIAL = SE.E2_FILIAL
				AND CTE.NF = SE.E2_NUM
				AND SE.E2_EMISSAO LIKE '2023%'
		), 0) CONTA_A_PAGAR_SALDO
	FROM CTE
		INNER JOIN CT2010 CT
			ON CT.CT2_FILORI = CTE.FILIAL
			AND SUBSTRING(CT.CT2_KEY, CHARINDEX('00',  CT.CT2_KEY),  9) = CTE.NF
			AND CT.CT2_DEBITO = '210201001'
			AND CT.CT2_DATA LIKE '2023%'
	GROUP BY
		CTE.FILIAL,
		CTE.NF,
		CTE.CREDITO,
		SUBSTRING(CT.CT2_CLVLCR, 2, 6),
		CTE.FORNECEDOR_CR
